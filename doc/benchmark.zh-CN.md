# Benchmark
本项目内置了性能测试脚本```ngxway_benchmark```，提供了QPS、耗时、内存、CPU等观测指标。

### 依赖安装
- 压测主要基于```ab```工具实现。如果在您的机器上未安装```ab```工具，请先 [安装ab工具](https://github.com/WGrape/ngxway/wiki/Q&A#1-how-to-install-ab) 。

## 1. 如何使用
在启动本项目后，使用以下命令即可开始性能测试。

```bash
bash bin/ngxway_benchmark api
```

## 2. 测试过程
开始运行时，```ngxway_benchmark```会在当前机器下，默认执行以下14个测试用例

- ```-n 10000 -c 32``` ：32个并发请求，完成总计10000个请求后结束
- ```-n 10000 -c 64``` ：64个并发请求，完成总计10000个请求后结束
- ```-n 10000 -c 128``` ：128个并发请求，完成总计10000个请求后结束
- ```-n 10000 -c 256``` ：256个并发请求，完成总计10000个请求后结束
- ```-n 10000 -c 512``` ：512个并发请求，完成总计10000个请求后结束
- ```-n 10000 -c 1024``` ：1024个并发请求，完成总计10000个请求后结束
- ```-n 10000 -c 1200``` ：1200个并发请求，完成总计10000个请求后结束
- ```-n 100000 -c 32``` ：32个并发请求，完成总计100000个请求后结束
- ```-n 100000 -c 64``` ：64个并发请求，完成总计100000个请求后结束
- ```-n 100000 -c 128``` ：128个并发请求，完成总计100000个请求后结束
- ```-n 100000 -c 256``` ：256个并发请求，完成总计100000个请求后结束
- ```-n 100000 -c 512``` ：512个并发请求，完成总计100000个请求后结束
- ```-n 100000 -c 1024``` ：1024个并发请求，完成总计100000个请求后结束
- ```-n 100000 -c 1200``` ：1200个并发请求，完成总计100000个请求后结束

在运行过程中，命令会也会显示实时压测信息。

<img width="876" alt="image" src="https://user-images.githubusercontent.com/35942268/224525700-692df740-92f5-4ad6-8343-0ea7ebccd8ad.png">

## 3. 测试报告
在完成测试后，系统会在项目根目录的```logs```文件夹下生成```{ngxwayPath}/logs/benchmark.html```测试报告文件。

当您在Mac系统上操作时，系统自动在Chrome浏览器中打开测试报告。如果您的系统不是Mac或者未正常打开测试报告，手动打开查看即可。

<img width="1000" alt="image" src="https://user-images.githubusercontent.com/35942268/224526169-3ca6cd09-380d-4acf-b184-b972db85685b.png">

## 4. 测试总结
在```8C16G```机器下，不进行额外的优化，ngxway网关服务的QPS浮动在```3w~6w```之间，平均```5W```。

## 5、性能对比
除了测试ngxway性能外，也进行了多次不同的性能对比，主要有以下结论。

- Docker的```bridge```网络模式对服务性能有```30%```左右的额外损耗，所以如果追求更高性能，请在```ngxway.conf```配置文件中设置```docker_network```为```host```模式

- 在等同的测试条件下，ngxway的性能约占 [go test](https://github.com/WGrape/ngxway/blob/d11c8a10bbd1c1cf382e5564515907875a75d56e/example/goserver/main.go#L16) 接口性能的```50%~70%```左右，也就是说如果在您的机器上 [go test](https://github.com/WGrape/ngxway/blob/d11c8a10bbd1c1cf382e5564515907875a75d56e/example/goserver/main.go#L16) 接口的压测可以达到10W的QPS，那么ngxway可以达到```5w~7w```的QPS


